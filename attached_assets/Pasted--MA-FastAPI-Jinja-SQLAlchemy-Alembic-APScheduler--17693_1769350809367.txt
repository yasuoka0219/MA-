既存のMAツール（FastAPI + Jinja + SQLAlchemy + Alembic + APScheduler）に対して、シナリオごとに「送付対象者を条件で絞る（セグメント）」機能と「送信対象者プレビュー」機能を追加してください。対象者を手選択するUIは作らず、必ずルール（条件）で制御してください。既存のシナリオやCSV運用、送信ロジックは壊さず後方互換を維持してください。

目的

現状は「トリガーに一致する全員」が対象になってしまい、OCなどの運用で対象を絞れない。
ただし手選択は属人化や事故につながるため、シナリオ＝ルールとして、条件で絞り込む形にする。
さらに運用者が安心できるように「次回送信対象が何件か」「サンプルで誰が対象か」を事前に確認できるプレビュー機能を追加する。

1. セグメント条件（シナリオに追加する項目）
1-1. 追加項目（最小構成）

シナリオに以下の“任意”条件を追加し、未指定なら「絞り込みなし」とする。

segment_event_type（例：oc / 資料請求 / 説明会 など）

※event_date/イベント管理機能を入れている場合は event_type に相当

segment_graduation_year_from（int / nullable）

segment_graduation_year_to（int / nullable）

segment_grade_in（string or json / nullable）

例：["高1","高2","高3"] など（既存のgrade列があればそれを使う）

segment_prefecture（string / nullable）

都道府県（既存に住所列がなければ一旦スキップしてOK）

segment_tag（string / nullable）

もしタグ概念がないなら将来用でOK（DBだけ先でも可）

1-2. 除外条件（事故防止）

必ず以下の“除外”は共通で効かせる（既存があるなら流用）。

配信停止（unsubscribe済み）は必ず除外

メールアドレス不正/空は除外（email-validator利用）

送信ログがある場合、同一シナリオでの重複送信は既存ルールを維持

2. UI変更（シナリオ作成/編集画面）
2-1. シナリオフォームに「送信対象の条件」を追加

今のフォームに折りたたみ（アコーディオン）でもいいので「送信対象の条件」セクションを追加。

イベント種別（トリガーに紐付くなら “表示だけ”でもOK）

卒業年度（from/to）

学年（チェックボックス複数選択）

（任意）都道府県

（任意）タグ

重要：未入力の場合は絞り込みをかけない（既存シナリオ互換）

2-2. 一覧の視認性

シナリオ一覧に「条件あり/なし」が一目で分かる表示を追加

例：条件列に「—」or 「卒業年度: 2026-2027 / 学年: 高2-高3」など短く表示

詳細画面では条件をフル表示

3. 「送信対象プレビュー」機能（重要）
3-1. どこに出すか

シナリオ詳細画面（詳細ボタン先）に以下を追加：

次回送信対象（概算）件数

サンプル対象者（最大10件）

個人情報が気になる場合はメールをマスク（例：a***@example.com）

“今この条件で送られる理由” を1行で表示（例：トリガー=oc, event_type=oc, 卒業年度=2026〜）

3-2. どう計算するか（仕様）

プレビューは「次のtick（スケジューラ実行）で対象になり得る人」を確認したいので以下のいずれかで実装：

A（簡易でOK）：条件に一致する母数の件数＋サンプル

“次回送信”ではなく “条件一致” の母数を見せる

UI文言で「条件一致する候補：xxx件」と表現

B（推奨）：実際の送信判定ロジックで「send_atが近いもの」を計算

schedulerの抽出関数を共通化して、その関数をプレビューにも使う

“今〜次回tickまで” or “今日送信予定” の対象を表示

既存の頻度/遅延/基準日（lead_created_at/event_date）を考慮

開発状況に合わせてA→Bへ段階的でも可。まずはAで完成させる。

4. スケジューラ送信対象抽出にセグメント条件を適用
4-1. 適用タイミング

送信対象を抽出するクエリに、シナリオのセグメント条件を必ず反映する。

graduation_year from/to → 範囲フィルタ

grade_in → INフィルタ

event_type → 一致フィルタ（event機能がある場合はregistration側に紐付け）

prefecture/tag → ある場合のみ適用

4-2. 共通関数化（推奨）

get_target_leads_for_scenario(scenario, now) のような関数を作り、

schedulerも

previewも
同じ関数を呼ぶ（ロジックのズレを防ぐ）

5. DB migration（Alembic）

scenariosテーブル（または該当）にセグメント用カラム追加

null許容で後方互換

既存データは baseで条件なしとして扱う

6. 受け入れ条件（この状態まで）

シナリオ作成/編集画面に「送信対象の条件」が追加されている

条件未入力の既存シナリオは、これまで通り全員対象で動く（互換）

条件を入れると送信対象が絞られる

シナリオ詳細に「条件一致候補の件数」と「サンプル（最大10件）」が表示される

配信停止/不正メールは候補から除外される

uv run python -m uvicorn ... で起動してUIが動く

7. 実装対象ファイル（目安）

models: src/ma_tool/models/scenario.py（セグメント追加）

migration: alembic/versions/*_add_scenario_segments.py

endpoints:

src/ma_tool/api/endpoints/views.py（UIルーティング）

src/ma_tool/api/endpoints/scheduler_api.py（抽出ロジック反映）

templates:

シナリオ作成/編集テンプレ

シナリオ詳細テンプレ（プレビュー表示）

8. 仕上げ（運用者が迷わない文言）

UI文言を以下のニュアンスに統一：

「対象者を選ぶ」ではなく「対象者の条件」

「次回送信対象」ではなく「条件一致候補」(Aの場合)

「条件が未設定の場合、トリガー一致の全員が対象になります」と注釈