# 本番環境でCSVアップロードができないときの確認事項

## 今回の修正内容

1. **インポート結果画面のバグ修正**  
   `ui_import.html` で、完了画面の「追加件数・更新件数・エラー件数」が正しい属性名（`result.added` / `result.updated` / `result.errors`）を参照するように修正しました。以前は `added_count` など存在しない属性を参照しており、**インポート実行後に 500 や画面崩れの原因**になっていました。

2. **ファイルサイズ制限とエラー表示**  
   - 設定で **`CSV_MAX_UPLOAD_MB`**（デフォルト 50MB）を追加。これを超えるCSVは「ファイルが大きすぎます」と表示して弾きます。
   - プレビュー時の `file.read()` 失敗時も、ユーザー向けのメッセージを出してエラー画面を返すようにしました。

3. **本番でまだアップロードできない場合の切り分け**  
   以下を順に確認してください。

---

## 確認手順

### 1. ブラウザの開発者ツールでエラーを確認

1. CSVインポート画面で **F12** または右クリック → **検証** で開発者ツールを開く
2. **Network（ネットワーク）** タブを開いた状態で、CSVを選択して「プレビュー」をクリック
3. 一覧に出る **`preview`** または **`import/preview`** のリクエストをクリック
4. **Status** を確認:
   - **413** → リクエストボディが大きいと判断されている（下記「ファイルサイズ」参照）
   - **500** → サーバー側エラー（Railway のログで Traceback を確認）
   - **302 → ログイン** → セッション切れ（再ログインしてから再度アップロード）
   - **200** なのに画面がおかしい → 上記テンプレート修正の反映（デプロイ）を確認

### 2. ファイルサイズ

- 本番では **50MB を超えるCSV** は「ファイルが大きすぎます」と表示されます。
- それより小さいのに 413 が出る場合は、Railway 側やプロキシの制限の可能性があります。  
  **Variables** で **`CSV_MAX_UPLOAD_MB`** を **10** など小さくして、小さなCSVで「プレビュー」が通るか試してください。
- 大きなCSVは **複数ファイルに分割** して、何度かに分けてインポートする運用にしてください。

### 3. セッション（ログイン状態）

- アップロード先は **ログイン必須** です。  
  **Cookie** が無効・期限切れだと、プレビュー時にログイン画面に飛ばされます。
- 本番の **`BASE_URL`** が実際のドメインと一致しているか確認してください（Cookie の domain に影響します）。

### 4. デプロイの反映

- 上記の **テンプレート・設定・エラー処理** の修正を本番に反映するには、**再デプロイ**（`railway up` または GitHub からの自動デプロイ）が必要です。
- 反映後、もう一度「プレビュー」→「インポート実行」まで試してください。

---

## まとめ

- **インポート結果画面で落ちていた** → テンプレート修正で解消される想定です。
- **「プレビュー」を押すと 413 / 500 / ログインに飛ぶ** → 上記の確認手順で原因を切り分け、必要なら `CSV_MAX_UPLOAD_MB` の調整やファイル分割で対応してください。
