{% extends "ui_base.html" %}

{% block title %}CSVインポート - MA Tool{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-upload"></i> CSVインポート</h2>
</div>

{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if step == 'upload' %}
<div class="card shadow-sm">
    <div class="card-header">
        <i class="bi bi-file-earmark-arrow-up"></i> CSVファイルをアップロード
    </div>
    <div class="card-body">
        <form method="POST" action="/ui/import/preview" enctype="multipart/form-data" id="upload-form">
            <div class="mb-4">
                <label class="form-label">CSVファイル</label>
                <input type="file" name="file" class="form-control" accept=".csv" required>
                <div class="form-text">
                    UTF-8またはShift_JIS(cp932)エンコーディングに対応しています。
                </div>
            </div>
            
            <div class="alert alert-info">
                <h6><i class="bi bi-info-circle"></i> 対応CSVフォーマット</h6>
                <p class="mb-2">以下のヘッダーを認識します：</p>
                <ul class="mb-0">
                    <li><strong>個人ID</strong> → external_id（任意）</li>
                    <li><strong>漢字氏名</strong> → name（推奨）</li>
                    <li><strong>メールアドレス1</strong> → email（必須・優先）</li>
                    <li><strong>メールアドレス2</strong> → email（フォールバック）</li>
                    <li><strong>卒年</strong> → graduation_year（必須、または学年を指定）</li>
                    <li><strong>学年</strong> → grade_label（卒年がない場合の代替）</li>
                    <li><strong>高校正式名称</strong> → school_name（推奨）</li>
                    <li><strong>興味関心タグ</strong> → interest_tags（任意）</li>
                    <li><strong>同意</strong> → consent（任意、デフォルト: はい）</li>
                </ul>
            </div>
            
            <div class="alert alert-warning">
                <h6><i class="bi bi-download"></i> CSV見本をダウンロード</h6>
                <p class="mb-2">フォーマットが分からない場合は、見本ファイルをダウンロードしてご利用ください。</p>
                <a href="/ui/import/template" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-download"></i> CSV見本をダウンロード
                </a>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" id="submit-btn">
                    <span class="spinner-border spinner-border-sm d-none me-2" id="loading-spinner"></span>
                    <i class="bi bi-eye" id="preview-icon"></i>
                    プレビュー
                </button>
            </div>
        </form>
    </div>
</div>

{% elif step == 'preview' and preview %}
<div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-table"></i> インポートプレビュー</span>
        <span class="badge bg-secondary">セッション: {{ session_id[:8] }}...</span>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h4>{{ preview.will_add }}</h4>
                        <small>新規追加</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h4>{{ preview.will_update }}</h4>
                        <small>更新</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body text-center">
                        <h4>{{ preview.will_skip }}</h4>
                        <small>スキップ</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h4>{{ preview.error_count }}</h4>
                        <small>エラー</small>
                    </div>
                </div>
            </div>
        </div>
        
        <h6>カラムマッピング</h6>
        <div class="table-responsive mb-4">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>CSVヘッダー</th>
                        <th>マッピング先</th>
                        <th>信頼度</th>
                    </tr>
                </thead>
                <tbody>
                    {% for col in preview.mapping.columns %}
                    <tr>
                        <td>{{ col.original }}</td>
                        <td>
                            {% if col.mapped_to %}
                            <span class="badge bg-success">{{ col.mapped_to }}</span>
                            {% else %}
                            <span class="text-muted">未マッピング</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if col.confidence >= 0.8 %}
                            <span class="text-success">{{ (col.confidence * 100)|int }}%</span>
                            {% elif col.confidence >= 0.5 %}
                            <span class="text-warning">{{ (col.confidence * 100)|int }}%</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if preview.preview_rows %}
        <h6>プレビュー（最初の{{ preview.preview_rows|length }}件）</h6>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>操作</th>
                        <th>メール</th>
                        <th>氏名</th>
                        <th>学校</th>
                        <th>卒年</th>
                        <th>備考</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in preview.preview_rows %}
                    <tr class="{% if row.errors %}table-danger{% elif row.action == 'add' %}table-success{% elif row.action == 'update' %}table-info{% endif %}">
                        <td>
                            {% if row.errors %}
                            <span class="badge bg-danger">エラー</span>
                            {% elif row.action == 'add' %}
                            <span class="badge bg-success">追加</span>
                            {% elif row.action == 'update' %}
                            <span class="badge bg-primary">更新</span>
                            {% else %}
                            <span class="badge bg-secondary">スキップ</span>
                            {% endif %}
                        </td>
                        <td>{{ row.normalized.email or '-' }}</td>
                        <td>{{ row.normalized.name or '-' }}</td>
                        <td>{{ row.normalized.school_name or '-' }}</td>
                        <td>{{ row.normalized.graduation_year or '-' }}</td>
                        <td>
                            {% if row.errors %}
                            <span class="text-danger small">{{ row.errors|join(', ') }}</span>
                            {% elif row.warnings %}
                            <span class="text-warning small">{{ row.warnings|join(', ') }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
        <hr>
        
        <form method="POST" action="/ui/import/confirm">
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success" {% if preview.error_count > 0 and preview.will_add == 0 and preview.will_update == 0 %}disabled{% endif %}>
                    <i class="bi bi-check-circle"></i> インポート実行
                </button>
                <a href="/ui/import" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 戻る
                </a>
            </div>
            {% if preview.error_count > 0 %}
            <div class="form-text text-warning mt-2">
                <i class="bi bi-exclamation-triangle"></i> エラーのある行はスキップされます
            </div>
            {% endif %}
        </form>
    </div>
</div>

{% elif step == 'result' and result %}
<div class="card shadow-sm">
    <div class="card-header bg-success text-white">
        <i class="bi bi-check-circle"></i> インポート完了
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3>{{ result.added_count }}</h3>
                        <small>新規追加</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3>{{ result.updated_count }}</h3>
                        <small>更新</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h3>{{ result.error_count }}</h3>
                        <small>エラー</small>
                    </div>
                </div>
            </div>
        </div>
        
        {% if result.errors %}
        <div class="alert alert-warning">
            <h6><i class="bi bi-exclamation-triangle"></i> エラー詳細</h6>
            <ul class="mb-0">
                {% for error in result.errors[:20] %}
                <li>行{{ error.row }}: {{ error.message }}</li>
                {% endfor %}
                {% if result.errors|length > 20 %}
                <li>...他 {{ result.errors|length - 20 }}件</li>
                {% endif %}
            </ul>
        </div>
        {% endif %}
        
        <div class="d-flex gap-2">
            <a href="/ui/leads" class="btn btn-primary">
                <i class="bi bi-people"></i> リード一覧を見る
            </a>
            <a href="/ui/import" class="btn btn-outline-primary">
                <i class="bi bi-upload"></i> 続けてインポート
            </a>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.getElementById('upload-form')?.addEventListener('submit', function() {
    document.getElementById('loading-spinner').classList.remove('d-none');
    document.getElementById('preview-icon').classList.add('d-none');
    document.getElementById('submit-btn').disabled = true;
});
</script>
{% endblock %}
