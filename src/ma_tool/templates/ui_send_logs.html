{% extends "ui_base.html" %}
{% block title %}配信ログ - MA Tool{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-envelope me-2"></i>配信ログ</h2>
    {% if lead %}
    <div>
        <a href="/ui/leads/{{ lead.id }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> リード詳細に戻る
        </a>
    </div>
    {% endif %}
</div>

{% if lead %}
<div class="alert alert-info mb-4">
    <i class="bi bi-info-circle"></i> 
    <strong>{{ lead.email }}</strong> への送信履歴を表示しています
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-md-2">
        <a href="/ui/send-logs?days={{ days }}" class="card text-decoration-none {% if not status_filter %}border-primary{% endif %}">
            <div class="card-body text-center py-2">
                <h5 class="mb-0">{{ status_counts.all }}</h5>
                <small class="text-muted">すべて</small>
            </div>
        </a>
    </div>
    <div class="col-md-2">
        <a href="/ui/send-logs?status_filter=scheduled&days={{ days }}" class="card text-decoration-none {% if status_filter == 'scheduled' %}border-info{% endif %}">
            <div class="card-body text-center py-2">
                <h5 class="mb-0 text-info">{{ status_counts.scheduled }}</h5>
                <small class="text-muted">予約中</small>
            </div>
        </a>
    </div>
    <div class="col-md-2">
        <a href="/ui/send-logs?status_filter=sent&days={{ days }}" class="card text-decoration-none {% if status_filter == 'sent' %}border-success{% endif %}">
            <div class="card-body text-center py-2">
                <h5 class="mb-0 text-success">{{ status_counts.sent }}</h5>
                <small class="text-muted">送信済</small>
            </div>
        </a>
    </div>
    <div class="col-md-2">
        <a href="/ui/send-logs?status_filter=failed&days={{ days }}" class="card text-decoration-none {% if status_filter == 'failed' %}border-danger{% endif %}">
            <div class="card-body text-center py-2">
                <h5 class="mb-0 text-danger">{{ status_counts.failed }}</h5>
                <small class="text-muted">失敗</small>
            </div>
        </a>
    </div>
    <div class="col-md-2">
        <a href="/ui/send-logs?status_filter=blocked&days={{ days }}" class="card text-decoration-none {% if status_filter == 'blocked' %}border-secondary{% endif %}">
            <div class="card-body text-center py-2">
                <h5 class="mb-0 text-secondary">{{ status_counts.blocked }}</h5>
                <small class="text-muted">ブロック</small>
            </div>
        </a>
    </div>
    <div class="col-md-2">
        <select class="form-select" onchange="window.location.href='/ui/send-logs?days='+this.value+'&status_filter={{ status_filter }}'">
            <option value="7" {% if days == 7 %}selected{% endif %}>直近7日</option>
            <option value="14" {% if days == 14 %}selected{% endif %}>直近14日</option>
            <option value="30" {% if days == 30 %}selected{% endif %}>直近30日</option>
            <option value="90" {% if days == 90 %}selected{% endif %}>直近90日</option>
        </select>
    </div>
</div>

<div class="card">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>日時</th>
                    <th>リード</th>
                    <th>シナリオ</th>
                    <th>チャネル</th>
                    <th>ステータス</th>
                    <th>詳細</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td>
                        {{ log.created_at.strftime('%m/%d %H:%M') if log.created_at else '-' }}
                    </td>
                    <td>
                        {% if log.lead_id in leads %}
                        <a href="/ui/leads/{{ log.lead_id }}">{{ leads[log.lead_id].email }}</a>
                        {% else %}
                        <span class="text-muted">ID: {{ log.lead_id }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if log.scenario_id in scenarios %}
                        <a href="/ui/scenarios/{{ log.scenario_id }}">{{ scenarios[log.scenario_id].name }}</a>
                        {% else %}
                        <span class="text-muted">ID: {{ log.scenario_id }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if log.channel.value == 'line' %}
                        <span class="badge bg-success">LINE</span>
                        {% else %}
                        <span class="badge bg-primary">Email</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if log.status.value == 'scheduled' %}
                        <span class="badge bg-info">予約中</span>
                        {% elif log.status.value == 'sent' %}
                        <span class="badge bg-success">送信済</span>
                        {% if log.opened_at %}
                        <i class="bi bi-eye text-success" title="開封済"></i>
                        {% endif %}
                        {% elif log.status.value == 'failed' %}
                        <span class="badge bg-danger">失敗</span>
                        {% elif log.status.value == 'blocked' %}
                        <span class="badge bg-secondary">ブロック</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/ui/send-logs/{{ log.id }}" class="btn btn-sm btn-outline-primary" 
                           data-bs-toggle="tooltip" data-bs-placement="top" title="詳細を表示">
                            <i class="bi bi-eye"></i> 詳細
                        </a>
                        {% if log.error_message %}
                        <small class="text-danger d-block mt-1" title="{{ log.error_message }}">
                            {{ log.error_message[:30] }}{% if log.error_message|length > 30 %}...{% endif %}
                        </small>
                        {% elif log.provider_message_id %}
                        <small class="text-muted d-block mt-1">{{ log.provider_message_id[:15] }}...</small>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        配信ログがありません
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if total_count and total_count > per_page %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page - 1 }}&status_filter={{ status_filter }}&channel_filter={{ channel_filter }}&days={{ days }}">前へ</a>
        </li>
        {% endif %}
        <li class="page-item disabled">
            <span class="page-link">
                {% if total_count > 0 %}
                {{ start_item }}-{{ end_item }}件 / 全{{ total_count }}件 ({{ page }} / {{ total_pages }}ページ)
                {% else %}
                0件
                {% endif %}
            </span>
        </li>
        {% if page * per_page < total_count %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page + 1 }}&status_filter={{ status_filter }}&channel_filter={{ channel_filter }}&days={{ days }}">次へ</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<script>
// Bootstrap tooltipの初期化
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
