{% extends "ui_base.html" %}
{% block title %}{% if is_new %}新規テンプレート{% else %}テンプレート編集{% endif %} - MA Tool{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/ui/templates">テンプレート一覧</a></li>
        <li class="breadcrumb-item active">{% if is_new %}新規作成{% else %}{{ template.name }}{% endif %}</li>
    </ol>
</nav>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">{% if is_new %}新規テンプレート{% else %}テンプレート編集{% endif %}</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{% if is_new %}/ui/templates/new{% else %}/ui/templates/{{ template.id }}/edit{% endif %}">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">テンプレート名 <span class="text-danger">*</span></label>
                        <input type="text" name="name" class="form-control" value="{{ template.name if template else '' }}" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">チャネル <span class="text-danger">*</span></label>
                        <select name="channel_type" class="form-select" id="channel-select" onchange="toggleChannelFields()">
                            <option value="email" {% if template and template.channel_type.value == 'email' %}selected{% elif is_new %}selected{% endif %}>Email</option>
                            <option value="line" {% if template and template.channel_type.value == 'line' %}selected{% endif %}>LINE</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="email-fields" style="display: none;">
                <div class="mb-3">
                    <label class="form-label">件名 <span class="text-muted small">(Email Subject)</span></label>
                    <div class="input-group mb-2">
                        <input type="text" name="subject" class="form-control" id="email-subject" value="{{ template.subject if template else '' }}" placeholder="例: {{ '{{' }} lead_name {{ '}}' }}様へのご案内">
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="subject-variable-dropdown">
                                <i class="bi bi-plus-circle"></i> 変数を挿入
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="subject-variable-dropdown">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="insertSubjectVariable('lead_name'); return false;">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-person me-2"></i>
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">氏名</div>
                                                <small class="text-muted">リードの名前が入ります</small>
                                            </div>
                                            <code class="ms-2 small">{{ '{{' }} lead_name {{ '}}' }}</code>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="insertSubjectVariable('lead_email'); return false;">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-envelope me-2"></i>
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">メールアドレス</div>
                                                <small class="text-muted">リードのメールアドレスが入ります</small>
                                            </div>
                                            <code class="ms-2 small">{{ '{{' }} lead_email {{ '}}' }}</code>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="insertSubjectVariable('lead_school_name'); return false;">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-building me-2"></i>
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">高校名</div>
                                                <small class="text-muted">リードの高校名が入ります</small>
                                            </div>
                                            <code class="ms-2 small">{{ '{{' }} lead_school_name {{ '}}' }}</code>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="insertSubjectVariable('lead_graduation_year'); return false;">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar3 me-2"></i>
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">卒業年度</div>
                                                <small class="text-muted">リードの卒業年度が入ります</small>
                                            </div>
                                            <code class="ms-2 small">{{ '{{' }} lead_graduation_year {{ '}}' }}</code>
                                        </div>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <button type="button" class="btn btn-outline-secondary" onclick="previewSubject()" title="件名プレビュー">
                            <i class="bi bi-eye"></i> プレビュー
                        </button>
                    </div>
                    
                    <!-- 件名プレビュー -->
                    <div id="subject-preview" class="alert alert-info d-none mb-0">
                        <small class="d-block mb-1"><strong>プレビュー:</strong></small>
                        <div id="subject-preview-text" class="fw-bold"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">本文（HTML）</label>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-success" onclick="insertLineUrl()">
                                <i class="bi bi-chat-dots"></i> LINE友だち追加URLを挿入
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePreview()">
                                <i class="bi bi-phone"></i> プレビュー
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-7" id="editor-col">
                            <textarea name="body" class="form-control" rows="18" id="email-body">{{ template.body_html if template else '' }}</textarea>
                        </div>
                        <div class="col-md-5 d-none" id="preview-col">
                            <div class="border rounded bg-white p-2" style="height: 400px; overflow: auto;">
                                <div class="mx-auto" id="preview-wrapper" style="max-width: 375px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #f8f9fa;">
                                    <div id="preview-content" style="font-size: 14px;"></div>
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm mt-2 w-100">
                                <button type="button" class="btn btn-outline-secondary active" onclick="setPreviewWidth(375)">スマホ</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setPreviewWidth(768)">タブレット</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setPreviewWidth('100%')">PC</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-text mt-2">
                        <strong>利用可能な変数:</strong>
                        <code>{{ '{{' }} lead_name {{ '}}' }}</code> - 氏名 |
                        <code>{{ '{{' }} lead_email {{ '}}' }}</code> - メールアドレス |
                        <code>{{ '{{' }} lead_school_name {{ '}}' }}</code> - 高校名 |
                        <code>{{ '{{' }} lead_graduation_year {{ '}}' }}</code> - 卒業年度 |
                        <code>{{ '{{' }} unsubscribe_url {{ '}}' }}</code> - 配信停止リンク |
                        <code>{{ '{{' }} line_friend_add_url {{ '}}' }}</code> - LINE友だち追加URL
                    </div>
                </div>
            </div>

            <div id="line-fields">
                <div class="mb-3">
                    <label class="form-label">メッセージテキスト</label>
                    <textarea name="message_text" class="form-control" rows="5" placeholder="LINEに送信するテキストメッセージ">{{ template.message_text if template else '' }}</textarea>
                    <div class="form-text">
                        利用可能な変数: <code>{name}</code>, <code>{school_name}</code>, <code>{graduation_year}</code>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Flex Message JSON（任意）</label>
                    <textarea name="flex_message_json" class="form-control font-monospace" rows="10" placeholder='{"type": "bubble", "body": {...}}'>{{ flex_json_str }}</textarea>
                    <div class="form-text">
                        LINE Flex Messageのフォーマットに従ってください。空の場合はテキストメッセージのみ送信されます。
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check"></i> 保存
                </button>
                <a href="{% if is_new %}/ui/templates{% else %}/ui/templates/{{ template.id }}{% endif %}" class="btn btn-outline-secondary">
                    キャンセル
                </a>
            </div>
        </form>
    </div>
</div>

<script>
function toggleChannelFields() {
    const channel = document.getElementById('channel-select').value;
    document.getElementById('email-fields').style.display = channel === 'email' ? 'block' : 'none';
    document.getElementById('line-fields').style.display = channel === 'line' ? 'block' : 'none';
}
toggleChannelFields();

function insertLineUrl() {
    const textarea = document.getElementById('email-body');
    const lineHtml = '\n<p style="text-align: center; margin-top: 20px;">\n  <a href="{{ line_friend_add_url }}" style="display: inline-block; background-color: #06C755; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold;">\n    <span style="font-size: 18px;">&#x1F4AC;</span> LINEで最新情報を受け取る\n  </a>\n</p>\n';
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    textarea.value = textBefore + lineHtml + textAfter;
    textarea.focus();
    updatePreview();
}

let previewVisible = false;
function togglePreview() {
    previewVisible = !previewVisible;
    const editorCol = document.getElementById('editor-col');
    const previewCol = document.getElementById('preview-col');
    if (previewVisible) {
        editorCol.className = 'col-md-7';
        previewCol.classList.remove('d-none');
        updatePreview();
    } else {
        editorCol.className = 'col-md-12';
        previewCol.classList.add('d-none');
    }
}

function updatePreview() {
    const body = document.getElementById('email-body').value;
    const preview = document.getElementById('preview-content');
    let html = body
        .replace(/\{\{\s*lead_name\s*\}\}/g, '山田 太郎')
        .replace(/\{\{\s*lead_email\s*\}\}/g, 'yamada@example.com')
        .replace(/\{\{\s*lead_school_name\s*\}\}/g, '○○高校')
        .replace(/\{\{\s*lead_graduation_year\s*\}\}/g, '2026')
        .replace(/\{\{\s*unsubscribe_url\s*\}\}/g, '#')
        .replace(/\{\{\s*line_friend_add_url\s*\}\}/g, '#');
    preview.innerHTML = html;
}

function setPreviewWidth(width) {
    const wrapper = document.getElementById('preview-wrapper');
    wrapper.style.maxWidth = typeof width === 'number' ? width + 'px' : width;
}

document.getElementById('email-body')?.addEventListener('input', updatePreview);

// 件名に変数を挿入
function insertSubjectVariable(varName) {
    const input = document.getElementById('email-subject');
    const variable = '{{ '{{' }} ' + varName + ' {{ '}}' }}';
    const cursorPos = input.selectionStart;
    const textBefore = input.value.substring(0, cursorPos);
    const textAfter = input.value.substring(cursorPos);
    input.value = textBefore + variable + textAfter;
    input.focus();
    input.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);
    previewSubject();
}

// 件名プレビュー
function previewSubject() {
    const subject = document.getElementById('email-subject').value;
    const previewDiv = document.getElementById('subject-preview');
    const previewText = document.getElementById('subject-preview-text');
    
    if (!subject.trim()) {
        previewDiv.classList.add('d-none');
        return;
    }
    
    // 変数をサンプル値に置き換え
    let preview = subject
        .replace(/\{\{\s*lead_name\s*\}\}/g, '山田 太郎')
        .replace(/\{\{\s*lead_email\s*\}\}/g, 'yamada@example.com')
        .replace(/\{\{\s*lead_school_name\s*\}\}/g, '○○高校')
        .replace(/\{\{\s*lead_graduation_year\s*\}\}/g, '2026');
    
    previewText.textContent = preview;
    previewDiv.classList.remove('d-none');
}

// 件名入力時にリアルタイムプレビュー
document.getElementById('email-subject')?.addEventListener('input', previewSubject);
</script>
{% endblock %}
