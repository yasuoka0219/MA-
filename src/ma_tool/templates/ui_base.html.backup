<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MA Tool{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        .env-banner {
            padding: 8px 16px;
            text-align: center;
            font-weight: 500;
        }
        .env-dev { background: #ffc107; color: #000; }
        .env-staging { background: #fd7e14; color: #fff; }
        .env-prod { background: #dc3545; color: #fff; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator, .htmx-request.htmx-indicator { display: inline-block; }
        .status-badge { font-size: 0.85rem; }
        .line-status-unlinked { background: #6c757d; }
        .line-status-linked { background: #198754; }
        .line-status-blocked { background: #dc3545; }
        .sidebar { min-height: 100vh; background: #212529; }
        .sidebar .nav-link { color: rgba(255,255,255,.75); padding: 12px 20px; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,.1); }
        .sidebar .nav-link i { margin-right: 10px; }
        .content-wrapper { min-height: 100vh; }
        .card-stat { border-left: 4px solid; }
        .card-stat-primary { border-color: #0d6efd; }
        .card-stat-success { border-color: #198754; }
        .card-stat-warning { border-color: #ffc107; }
        .card-stat-danger { border-color: #dc3545; }
    </style>
</head>
<body class="bg-light">
    {% if app_env != 'prod' %}
    <div class="env-banner env-{{ app_env }}">
        <i class="bi bi-exclamation-triangle"></i>
        {{ app_env|upper }}環境 - 本番送信されません（LINE/メールはテスト先にリダイレクト）
    </div>
    {% endif %}

    <div class="toast-container" id="toast-container"></div>

    <div class="d-flex">
        {% if current_user %}
        <nav class="sidebar d-flex flex-column" style="width: 250px;">
            <div class="p-3 text-white">
                <h5 class="mb-0">MA Tool</h5>
                <small class="text-muted">{{ current_user.name }}</small>
                <span class="badge bg-secondary ms-1">{{ current_user.role.value }}</span>
            </div>
            <hr class="text-secondary my-0">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link {% if request.url.path == '/ui/dashboard' %}active{% endif %}" href="/ui/dashboard">
                        <i class="bi bi-speedometer2"></i>ダッシュボード
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if '/ui/leads' in request.url.path and '/ui/line' not in request.url.path %}active{% endif %}" href="/ui/leads">
                        <i class="bi bi-people"></i>リード
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if '/ui/import' in request.url.path %}active{% endif %}" href="/ui/import">
                        <i class="bi bi-upload"></i>CSVインポート
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if '/ui/templates' in request.url.path %}active{% endif %}" href="/ui/templates">
                        <i class="bi bi-file-text"></i>テンプレート
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if '/ui/events' in request.url.path %}active{% endif %}" href="/ui/events">
                        <i class="bi bi-calendar-event"></i>イベント
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if '/ui/scenarios' in request.url.path %}active{% endif %}" href="/ui/scenarios">
                        <i class="bi bi-diagram-3"></i>シナリオ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if '/ui/send-logs' in request.url.path %}active{% endif %}" href="/ui/send-logs">
                        <i class="bi bi-envelope"></i>配信ログ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if '/ui/line-identities' in request.url.path %}active{% endif %}" href="/ui/line-identities">
                        <i class="bi bi-chat-dots"></i>LINE紐付け
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if '/ui/audit-logs' in request.url.path %}active{% endif %}" href="/ui/audit-logs">
                        <i class="bi bi-shield-check"></i>監査ログ
                    </a>
                </li>
                {% if current_user.role.value == 'admin' %}
                <li class="nav-item">
                    <a class="nav-link {% if '/ui/users' in request.url.path %}active{% endif %}" href="/ui/users">
                        <i class="bi bi-person-gear"></i>ユーザー管理
                    </a>
                </li>
                {% endif %}
            </ul>
            <hr class="text-secondary mt-auto">
            <ul class="nav flex-column mb-3">
                <li class="nav-item">
                    <a class="nav-link {% if '/ui/change-password' in request.url.path %}active{% endif %}" href="/ui/change-password">
                        <i class="bi bi-key"></i>パスワード変更
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/ui/logout">
                        <i class="bi bi-box-arrow-right"></i>ログアウト
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}

        <main class="content-wrapper flex-grow-1 p-4">
            {% block content %}{% endblock %}
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const bgClass = type === 'success' ? 'bg-success' : (type === 'error' ? 'bg-danger' : 'bg-warning');
            const toast = document.createElement('div');
            toast.className = `toast show align-items-center text-white ${bgClass} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        document.body.addEventListener('htmx:afterSwap', function(evt) {
            const trigger = evt.detail.xhr.getResponseHeader('HX-Trigger');
            if (trigger) {
                try {
                    const data = JSON.parse(trigger);
                    if (data.showToast) {
                        showToast(data.showToast.message, data.showToast.type);
                    }
                    if (data.refreshPage) {
                        // 少し遅延させてからリロード（トーストメッセージを表示するため）
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    }
                } catch(e) {}
            }
        });

        document.body.addEventListener('htmx:responseError', function(evt) {
            showToast('エラーが発生しました', 'error');
        });

        // ページ読み込み時にURLパラメータからメッセージを表示
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');
            if (message) {
                showToast(message, 'success');
                // URLからパラメータを削除（ブラウザの戻るボタンで再表示されないように）
                const newUrl = window.location.pathname + window.location.search.replace(/[?&]message=[^&]*/, '').replace(/^&/, '?');
                window.history.replaceState({}, '', newUrl);
            }
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
