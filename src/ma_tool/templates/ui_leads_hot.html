{% extends "ui_base.html" %}
{% block title %}é«˜æ¸©åº¦ãƒªãƒ¼ãƒ‰ - MA Tool{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-fire me-2"></i>é«˜æ¸©åº¦ãƒªãƒ¼ãƒ‰ä¸€è¦§</h2>
    <span class="badge bg-secondary">{{ total_count }}ä»¶</span>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-2">
                <label class="form-label">æ¸©åº¦</label>
                <select name="band" class="form-select">
                    <option value="">ã™ã¹ã¦</option>
                    <option value="hot" {% if band == 'hot' %}selected{% endif %}>ğŸ”¥ Hot ({{ hot_count }})</option>
                    <option value="warm" {% if band == 'warm' %}selected{% endif %}>ğŸŸ¡ Warm ({{ warm_count }})</option>
                    <option value="cold" {% if band == 'cold' %}selected{% endif %}>ğŸ”µ Cold ({{ cold_count }})</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">å’æ¥­å¹´åº¦</label>
                <select name="graduation_year" class="form-select">
                    <option value="">ã™ã¹ã¦</option>
                    {% for year in graduation_years %}
                    <option value="{{ year }}" {% if graduation_year == year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">ç›´è¿‘åå¿œï¼ˆæ—¥ä»¥å†…ï¼‰</label>
                <input type="number" name="days" class="form-control" value="{{ days or '' }}" placeholder="ä¾‹: 7" min="1">
            </div>
            <div class="col-md-2">
                <label class="form-label">PVæ•°ï¼ˆ7æ—¥ï¼‰â‰§</label>
                <input type="number" name="min_pv" class="form-control" value="{{ min_pv or '' }}" placeholder="ä¾‹: 5" min="0">
            </div>
            <div class="col-md-2">
                <label class="form-label">æ¤œç´¢</label>
                <input type="text" name="search" class="form-control" value="{{ search }}" placeholder="åå‰/ãƒ¡ãƒ¼ãƒ«">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2"><i class="bi bi-search"></i> æ¤œç´¢</button>
                <a href="/ui/leads/hot" class="btn btn-outline-secondary">ã‚¯ãƒªã‚¢</a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>æ¸©åº¦</th>
                    <th>ã‚¹ã‚³ã‚¢</th>
                    <th>åå‰</th>
                    <th>ãƒ¡ãƒ¼ãƒ«</th>
                    <th>å’æ¥­å¹´</th>
                    <th>æœ€çµ‚åå¿œ</th>
                    <th>ç›´è¿‘ã‚¯ãƒªãƒƒã‚¯URL</th>
                    <th>PV(7æ—¥)</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for item in leads_data %}
                <tr>
                    <td>
                        {% if item.lead.score_band == 'hot' %}
                        <span class="badge bg-danger">ğŸ”¥ Hot</span>
                        {% elif item.lead.score_band == 'warm' %}
                        <span class="badge bg-warning text-dark">ğŸŸ¡ Warm</span>
                        {% else %}
                        <span class="badge bg-info">ğŸ”µ Cold</span>
                        {% endif %}
                    </td>
                    <td><strong>{{ item.lead.engagement_score }}</strong></td>
                    <td>{{ item.lead.name or '-' }}</td>
                    <td>
                        <a href="/ui/leads/{{ item.lead.id }}">
                            {{ item.lead.email[:3] }}***{{ item.lead.email[item.lead.email.index('@'):] }}
                        </a>
                    </td>
                    <td>{{ item.lead.graduation_year or '-' }}</td>
                    <td>
                        {% if item.lead.last_engaged_at %}
                        {{ item.lead.last_engaged_at.strftime('%m/%d %H:%M') }}
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.last_click_url %}
                        <small class="text-truncate d-inline-block" style="max-width: 200px;" title="{{ item.last_click_url }}">
                            {{ item.last_click_url[:40] }}{% if item.last_click_url|length > 40 %}...{% endif %}
                        </small>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{{ item.pv_7d }}</td>
                    <td>
                        <a href="/ui/leads/{{ item.lead.id }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i> è©³ç´°
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        è©²å½“ã™ã‚‹ãƒªãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if total_count > per_page %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page - 1 }}&band={{ band }}&graduation_year={{ graduation_year or '' }}&days={{ days or '' }}&min_pv={{ min_pv or '' }}&search={{ search }}">å‰ã¸</a>
        </li>
        {% endif %}
        <li class="page-item disabled">
            <span class="page-link">{{ page }} / {{ total_pages }}ãƒšãƒ¼ã‚¸ï¼ˆå…¨{{ total_count }}ä»¶ï¼‰</span>
        </li>
        {% if page < total_pages %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page + 1 }}&band={{ band }}&graduation_year={{ graduation_year or '' }}&days={{ days or '' }}&min_pv={{ min_pv or '' }}&search={{ search }}">æ¬¡ã¸</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}
